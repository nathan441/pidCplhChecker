<!DOCTYPE html>
<html>

<head>
    <style
        type="text/css">
        body {
            font-family: Arial, sans-serif;
            background-color: #d1c698;
            color: #1f2524;
            text-align: center;
            border: #000000 4px solid;
            padding: 20px;
            margin-block: 20px 0;
             box-shadow:
            -1em 0 0.4em rgb(179, 77, 77),
            -1em 0 3em olive;
            
            
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            
        }  

        table {
            width: 100%;
            border: 5px solid #0e0d0d;
            border-collapse: collapse;
            margin: 10px 0;
            box-shadow:
            /* -1em 0 1em rgb(156, 42, 42),
            -1em 0 1em olive; */
            /* font-size: medium; */
        }
        th {
            padding: 8px;
            text-align: center;
            border-bottom: 4px solid #0f0f0f;
            background-color: #8a8100;
            font-weight: bold;
            vertical-align: middle;
        }
        td {
            padding: 8px;
            text-align: center;
            border-bottom: 2px solid #0a0a0a;
            border-left: #8a8100 4px solid;
            vertical-align: middle;
        }
    </style>
    <meta charset="UTF-8" />
    <title>PIDS CPLH</title>
</head>

<body>
    <h1>PIDs Cartons Page</h1>

    <p>Welcome to the PIDs Cartons Page!</p>
    <p>This page is designed to provide information about the PIDs cartons.</p>


    <input type="file" id="Upload" name="Import Data" accept=".csv" />
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- /////////////////////////////////////////////////////////////////////////////////////////// -->

     <label for="hour1">From: </label>
    <select id="hour1" name="hour1">
        <option value="1">7:30</option>
        <option value="2">8:30</option>
        <option value="3">9:30</option>
        <option value="4">10:30</option>
        <option value="5">11:30</option>
        <option value="6">12:30</option>
        <option value="7">13:30</option>
        <option value="8">14:30</option>
        <option value="9">15:30</option>
        <option value="10">16:30</option>
        <option value="11">17:30</option>
    </select>
    <label for="hour2">To: </label>
    <select id="hour2" name="hour2">
        <option value="1">7:30</option>
        <option value="2">8:30</option>
        <option value="3">9:30</option>
        <option value="4">10:30</option>
        <option value="5">11:30</option>
        <option value="6">12:30</option>
        <option value="7">13:30</option>
        <option value="8">14:30</option>
        <option value="9">15:30</option>
        <option value="10">16:30</option>
        <option value="11">17:30</option>
    </select>
    <button id="Search">Search</button>
    <button id="Clear">Clear</button>
    <div id="tableContainer"></div>

<!-- //////////////////////////////////////////////////////////////////////////////////////////////////////////// -->

  <script>
    document.getElementById('Upload').addEventListener('change', function (e) {
      const file = e.target.files[0];
      Papa.parse(file, {
        header: true,
        // dynamicTyping: true,
        complete: function (results) {
          const data = results.data;
          window.csvData = data; 
        //   filterAndDisplayData();
        }
      });
    });

    // Add event listener to the Search button
    document.getElementById('Search').addEventListener('click', filterAndDisplayData);
    document.getElementById('Clear').addEventListener('click', clearTable);


    function clearTable() {
      const container = document.getElementById('tableContainer');
      container.innerHTML = ''; // Clear previous content
    }



    function getHourFromId(idStr) {
      const match = idStr.match(/(\d{2}):(\d{2})/);
      return match ? match[0] : null;
    }

    // Function to display hour sums in a table
    // This function takes the filtered data and calculates sums for each hour interval
    function displayHourSums(data) {
    if (!data.length) return;
    const keys = Object.keys(data[0]);
    const hourIntervals = [
      "06:30-07:30", "07:30-08:30", "08:30-09:30", "09:30-10:30", "10:30-11:30",
      "11:30-12:30", "12:30-13:30", "13:30-14:30", "14:30-15:30", "15:30-16:30", "16:30-17:30"
    ];
    // Map interval to sum for each column
    const intervalSums = {};
    hourIntervals.forEach(interval => {
      intervalSums[interval] = {};
      keys.forEach(key => {
        intervalSums[interval][key] = 0;
      });
    });

    // Helper to get interval from Id
    function getIntervalFromId(idStr) {

      // Find which interval the Id belongs to
      const match = idStr.match(/(\d{2}):(\d{2})/);
      if (!match) return null;
      const hour = match[1];
      const minute = match[2];
      const time = `${hour}:${minute}`;
      for (let i = 0; i < hourIntervals.length; i++) {
        const [start, end] = hourIntervals[i].split("-");
        if (time >= start && time < end) return hourIntervals[i];
      }
      return null;
    }

    // Sum values for each interval and column
    data.forEach(row => {
      const interval = getIntervalFromId(row.Id);
      if (interval && intervalSums.hasOwnProperty(interval)) {
        keys.forEach(key => {
          const val = parseFloat(row[key]);
          if (!isNaN(val)) intervalSums[interval][key] += val;
        });
      }
    });

    // Create summary table: header is columns, rows are intervals
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');


    // Header row
    const headerRow = document.createElement('tr');
    const thInterval = document.createElement('th');
    thInterval.textContent = 'Hour Interval';
    headerRow.appendChild(thInterval);
    const thTotal = document.createElement('th');
    thTotal.textContent = 'Total';
    headerRow.appendChild(thTotal);

    // Add keys as header columns, skipping first and last column
    keys.forEach((key, idx) => {
      if (idx === 0 || idx === keys.length - 1) return; // skip first and last column
      if ((idx >=1 && idx <= 7)||(idx >=16 && idx <= 16)) return;
      const th = document.createElement('th');
      th.textContent = key;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);


    let totalCount = 0;
    let totalSum = 0;
    // Data rows: one per interval
    hourIntervals.forEach(interval => {
      const tr = document.createElement('tr');
      const tdInterval = document.createElement('td');
      tdInterval.textContent = interval;
      tr.appendChild(tdInterval);

      // Calculate total > 249 for this interval
      let totalOver249 = 0;
      let count = 0;
      keys.forEach((key, idx) => {
        if (idx === 0 || idx === keys.length - 1) return;
        if ((idx >=1 && idx <= 7)||(idx >=16 && idx <= 16)) return;
        const val = intervalSums[interval][key];
        if (val > 249){
          totalOver249 += val;
          count++;
        }
      });
      const tdTotal = document.createElement('td');
      tdTotal.textContent = Math.ceil(totalOver249/count); // Round up the average
      tr.appendChild(tdTotal);

      // Add regular columns
      keys.forEach((key, idx) => {
        if (idx === 0 || idx === keys.length - 1) return;
        if ((idx >=1 && idx <= 7)||(idx >=16 && idx <= 16)) return;
        const td = document.createElement('td');
        const cellVal = intervalSums[interval][key];

        if (cellVal > 249) {
          td.textContent = cellVal;
          totalSum = totalSum + cellVal;
          totalCount++;
        } else {
          td.textContent = '';
        }

        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(thead);
    table.appendChild(tbody);
    // Add below main table
    const container = document.getElementById('tableContainer');
    container.appendChild(document.createElement('br'));
    container.appendChild(table);
    // Display PidsCplh below the table
    if (totalCount > 0) {
      const pidsDiv = document.createElement('div');
      pidsDiv.style.marginTop = '48px'; // Increased margin to lower the section
      pidsDiv.style.fontWeight = 'bold';
      pidsDiv.style.fontSize = '1.2em';
      pidsDiv.textContent = `PidsCplh (Avg > 249): ${ (totalSum/totalCount).toFixed(2) }`;
      container.appendChild(pidsDiv);
    }
}


  function displayCplh(data) {
    if (!data.length) return;
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');

    // Header row
    const headerRow = document.createElement('tr'); 
    const thId = document.createElement('th');
    thId.textContent = 'Pid Cplh';
    headerRow.appendChild(thId);


  }




    function filterAndDisplayData() {
      if(!window.csvData) return ;
      const hourOptions = [
        "07:30", "08:30", "09:30", "10:30", "11:30", "12:30",
        "13:30", "14:30", "15:30", "16:30", "17:30"
      ]
      const fromIdx = Number(document.getElementById('hour1').value) - 1;
      const toIdx = Number(document.getElementById('hour2').value) - 1;
      if (fromIdx < 0 || toIdx < 0 ) {
        alert('ERROR!!!! Please select both Hours to filter.');
        return;
      }
        const from = hourOptions[fromIdx];
        const to = hourOptions[toIdx];

      const filteredData = window.csvData.filter(row => {
        const hour = getHourFromId(row.Id);
        if (!hour) return false; 
        return hour >= from && hour <= to;
      });

      displayHourSums(filteredData);
      displayCplh(filteredData);
    }
  </script>




</body>

</html>